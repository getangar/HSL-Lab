# =============================================================================
# NGINX Edge Server Configuration (CDN Simulator)
# =============================================================================
# This configuration simulates a CDN edge server, similar to what Akamai,
# Cloudflare, or Apple's own CDN would do in production.
#
# Key Functions:
# 1. Proxy requests to the origin server
# 2. Cache responses to reduce origin load
# 3. Add cache status headers for debugging
# 4. Handle CORS for browser-based players
#
# Cache Strategy:
# - .m3u8 playlists: 1 second cache (must stay fresh for live streaming)
# - .ts segments: 10 minute cache (segments are immutable once created)
#
# IMPORTANT: This container uses network_mode: host to avoid Docker bridge
# networking issues with iptables. It connects to the origin via the host's
# IP address (configured in the upstream block below).
#
# YOU MUST UPDATE THE ORIGIN IP ADDRESS BELOW to match your server's IP!
# =============================================================================

worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    # ==========================================================================
    # Logging
    # ==========================================================================
    # Custom log format includes cache status for debugging
    # Example: 192.168.1.100 - [31/Jan/2026:12:00:00] "GET /hls/test.m3u8" 200 204 cache:HIT rt:0.001
    log_format cdn '$remote_addr - [$time_local] "$request" '
                   '$status $body_bytes_sent '
                   'cache:$upstream_cache_status '
                   'rt:$request_time';
    
    access_log /var/log/nginx/access.log cdn;
    
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    
    # ==========================================================================
    # Cache Configuration
    # ==========================================================================
    # This creates a cache zone for HLS content.
    # 
    # Parameters:
    # - levels=1:2: Directory structure for cache files
    # - keys_zone=hls_cache:100m: 100MB for cache keys in memory
    # - max_size=1g: Maximum 1GB of cached content on disk
    # - inactive=10m: Remove items not accessed for 10 minutes
    # ==========================================================================
    proxy_cache_path /var/cache/nginx/hls 
                     levels=1:2 
                     keys_zone=hls_cache:100m 
                     max_size=1g 
                     inactive=10m 
                     use_temp_path=off;
    
    # ==========================================================================
    # Upstream: Origin Server
    # ==========================================================================
    # IMPORTANT: Change this IP to your server's actual IP address!
    # This is needed because the edge container uses host networking.
    #
    # To find your IP: hostname -I | awk '{print $1}'
    # ==========================================================================
    upstream origin {
        server 192.168.50.130:4002;  # <-- UPDATE THIS IP!
        keepalive 32;
    }
    
    server {
        listen 4003;
        server_name localhost;
        
        # ======================================================================
        # Health Check
        # ======================================================================
        location /health {
            add_header 'Access-Control-Allow-Origin' '*' always;
            return 200 'OK';
            add_header Content-Type text/plain;
        }
        
        # ======================================================================
        # Prometheus Metrics
        # ======================================================================
        location /stub_status {
            stub_status on;
            access_log off;
        }
        
        # ======================================================================
        # HLS Content with Caching
        # ======================================================================
        # All HLS requests go through this location block.
        # CORS headers are added to allow browser players to access content.
        # The X-Cache-Status header shows whether content was served from cache.
        #
        # Cache Status Values:
        # - MISS: Not in cache, fetched from origin
        # - HIT: Served from cache
        # - EXPIRED: Was in cache but expired, refreshed from origin
        # - STALE: Served stale content while refreshing in background
        # - UPDATING: Cache is being updated
        # - BYPASS: Cache was bypassed (not applicable here)
        # ======================================================================
        location /hls {
            proxy_pass http://origin;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_hide_header 'Access-Control-Allow-Origin';
            
            # CORS headers for browser players
            add_header 'Access-Control-Allow-Origin' '*' always;
            add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'Range' always;
            add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range,X-Cache-Status' always;
            
            # Cache status headers for debugging
            add_header X-Cache-Status $upstream_cache_status always;
            add_header X-Edge-Server "streaming-edge" always;
        }
        
        # ======================================================================
        # .ts Segments and .m3u8 Playlists
        # ======================================================================
        # This location handles the actual HLS files with caching.
        # Regex matches both .ts (video segments) and .m3u8 (playlists).
        # ======================================================================
        location ~ \.(ts|m3u8)$ {
            proxy_pass http://origin;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_hide_header 'Access-Control-Allow-Origin';
            
            # Enable caching
            proxy_cache hls_cache;
            proxy_cache_valid 200 1s;  # Short cache for live content
            proxy_cache_key $uri;
            proxy_cache_use_stale error timeout updating;
            proxy_cache_lock on;
            
            # CORS headers
            add_header 'Access-Control-Allow-Origin' '*' always;
            add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'Range' always;
            add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range,X-Cache-Status' always;
            
            # Cache status headers
            add_header X-Cache-Status $upstream_cache_status always;
            add_header X-Edge-Server "streaming-edge" always;
        }
        
        # ======================================================================
        # RTMP Statistics Proxy
        # ======================================================================
        location /stat {
            proxy_pass http://origin/stat;
            proxy_hide_header 'Access-Control-Allow-Origin';
            add_header 'Access-Control-Allow-Origin' '*' always;
        }
        
        # ======================================================================
        # Telemetry Endpoint
        # ======================================================================
        # Receives metrics from the web player.
        # In a real system, this would forward to a metrics pipeline.
        # ======================================================================
        location /telemetry {
            add_header 'Access-Control-Allow-Origin' '*' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'Content-Type' always;
            
            # Handle preflight requests
            if ($request_method = 'OPTIONS') {
                return 204;
            }
            
            # Accept and discard telemetry (in production, forward to pipeline)
            return 204;
        }
    }
}
