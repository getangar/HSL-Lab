# =============================================================================
# NGINX-RTMP Origin Server Configuration
# =============================================================================
# This configuration sets up:
# 1. RTMP server for receiving live streams
# 2. HLS packaging for adaptive streaming
# 3. HTTP server for serving HLS content
#
# HLS Settings:
# - Fragment duration: 2 seconds (balance between latency and stability)
# - Playlist length: 10 seconds (5 segments in playlist)
# - Cleanup enabled (old segments are removed automatically)
# =============================================================================

worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /run/nginx/nginx.pid;

# Load RTMP module
load_module /usr/lib/nginx/modules/ngx_rtmp_module.so;

events {
    worker_connections 1024;
    use epoll;
    multi_accept on;
}

# =============================================================================
# RTMP Configuration
# =============================================================================
rtmp {
    server {
        listen 1935;
        chunk_size 4096;
        
        # Live application - receives RTMP, outputs HLS
        application live {
            live on;
            record off;
            
            # Allow publishing from anywhere (for lab purposes)
            # In production, restrict this!
            allow publish all;
            allow play all;
            
            # =================================================================
            # HLS Configuration
            # =================================================================
            # HLS (HTTP Live Streaming) breaks the video into small segments
            # and creates a playlist (.m3u8) that players use to fetch segments.
            #
            # Key parameters:
            # - hls_fragment: Duration of each .ts segment
            # - hls_playlist_length: How much video the playlist covers
            # - hls_continuous: Continue numbering across restarts
            # - hls_cleanup: Remove old segments automatically
            # =================================================================
            hls on;
            hls_path /tmp/hls;
            hls_fragment 2s;
            hls_playlist_length 10s;
            hls_sync 100ms;
            hls_continuous on;
            hls_cleanup on;
        }
    }
}

# =============================================================================
# HTTP Configuration
# =============================================================================
http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    # Detailed logging for debugging
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" rt=$request_time';
    
    access_log /var/log/nginx/access.log main;
    
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    
    server {
        listen 8080;
        server_name localhost;
        
        # Health check endpoint for Docker healthcheck
        location /health {
            access_log off;
            return 200 'OK';
            add_header Content-Type text/plain;
        }
        
        # Prometheus metrics endpoint
        location /stub_status {
            stub_status on;
            access_log off;
            allow all;
        }
        
        # RTMP statistics page (useful for debugging)
        location /stat {
            rtmp_stat all;
            rtmp_stat_stylesheet stat.xsl;
            add_header Cache-Control no-cache;
        }
        
        location /stat.xsl {
            root /etc/nginx;
        }
        
        # =================================================================
        # HLS Content
        # =================================================================
        # Serves the HLS segments and playlists from /tmp/hls
        # 
        # CORS headers are added to allow browser players from other origins
        # to access the content. In production, you'd restrict this.
        # =================================================================
        location /hls {
            alias /tmp/hls;
            
            # CORS headers for browser players
            add_header 'Access-Control-Allow-Origin' '*' always;
            add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS' always;
            
            # .m3u8 playlists - no caching (must be fresh for live)
            location ~ \.m3u8$ {
                add_header 'Access-Control-Allow-Origin' '*' always;
                add_header Cache-Control "no-cache, no-store, must-revalidate";
                types {
                    application/vnd.apple.mpegurl m3u8;
                }
            }
            
            # .ts segments - can be cached (segments don't change)
            location ~ \.ts$ {
                add_header 'Access-Control-Allow-Origin' '*' always;
                add_header Cache-Control "public, max-age=3600";
                types {
                    video/mp2t ts;
                }
            }
        }
    }
}
